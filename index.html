<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Printed Concrete - Universal Cost Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Modern and Professional Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif; /* Changed font to Inter */
            background-color: #EAEFF5; /* Lighter, more professional background */
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
        }
        
        .container {
            max-width: 1400px;
            width: 100%; /* Ensure it takes full width within padding */
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: #FFFFFF; /* Solid white background */
            padding: 30px;
            border-radius: 12px; /* Slightly less rounded */
            box-shadow: 0 8px 24px rgba(0,0,0,0.08); /* Softer shadow */
        }
        
        .header h1 {
            color: #2C3E50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #4A90E2, #6A5ACD); /* Professional blue gradient */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex; /* Use flex to align icon and text */
            justify-content: center;
            align-items: center;
            gap: 10px; /* Space between icon and text */
        }

        .header h1 .icon {
            font-size: 1.2em; /* Adjust icon size relative to text */
            -webkit-text-fill-color: #4A90E2; /* Ensure icon is visible with gradient */
        }
        
        .company-info {
            color: #666666;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .project-input, .section {
            background: #FFFFFF;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            margin-bottom: 25px;
            transition: all 0.3s ease; /* Smooth transition for sections */
        }

        .project-input:hover, .section:hover {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); /* More prominent shadow on hover */
            transform: translateY(-2px);
        }
        
        .project-input h3, .section-header {
            color: #333333;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .section-header {
            background: #4A90E2; /* Solid primary color header */
            color: white;
            padding: 18px 25px;
            border-radius: 12px 12px 0 0;
            margin: -25px -25px 20px -25px; /* Adjust to cover padding of parent section */
            font-size: 1.1em;
            display: flex; /* For icon alignment */
            align-items: center;
            gap: 10px;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            color: #333333;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .input-group input, .input-group select {
            padding: 12px;
            border: 1px solid #D1D9E0; /* Softer border */
            border-radius: 8px; /* Slightly less rounded */
            font-size: 14px;
            transition: all 0.2s ease-in-out;
            color: #333333;
            background-color: #FDFDFD; /* Slightly off-white for inputs */
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.2); /* Slightly larger shadow on focus */
            background-color: #FFFFFF;
        }
        
        .printer-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .printer-card {
            border: 1px solid #D1D9E0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            position: relative;
            background-color: #F8F9FA; /* Light background for cards */
            box-shadow: 0 4px 10px rgba(0,0,0,0.04); /* Subtle shadow for cards */
        }
        
        .printer-card:hover {
            border-color: #4A90E2;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(74, 144, 226, 0.15); /* Stronger shadow on hover */
        }
        
        .printer-card.selected {
            border-color: #4A90E2;
            background-color: #E6F0FA; /* Lighter blue background for selected */
            box-shadow: 0 8px 16px rgba(74, 144, 226, 0.25); /* More prominent shadow for selected */
        }

        .printer-card.selected::after {
            content: '✔️';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5em;
            color: #4A90E2;
        }
        
        .printer-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #333333;
            margin-bottom: 15px;
        }
        
        .pricing-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .pricing-option {
            text-align: center;
            padding: 12px;
            border: 1px solid #E0E6ED;
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            position: relative;
            background-color: #FFFFFF;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); /* Very subtle shadow */
        }
        
        .pricing-option:hover {
            background-color: #F0F4F8;
            box-shadow: 0 4px 8px rgba(0,0,0,0.06);
        }
        
        .pricing-option.selected {
            background: #4A90E2; /* Primary blue for selected option */
            color: white;
            border-color: #4A90E2;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2);
        }

        .pricing-option.selected::after {
            content: '✔️';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1.0em;
            color: white;
        }
        
        .price-amount {
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .price-label {
            font-size: 0.8em;
            opacity: 0.9;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #E0E6ED; /* Subtle border for table container */
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); /* Shadow for entire table block */
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            background-color: #FFFFFF;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #E0E6ED;
        }
        
        th {
            background-color: #F8F9FA; /* Light background for headers */
            color: #333333;
            font-weight: 600;
        }
        
        tr:last-child td {
            border-bottom: none; /* No border for the last row */
        }

        .editable {
            background-color: #FFFCEE; /* Softer yellow */
            border: 1px solid #FFEDC2; /* Softer border */
            padding: 8px;
            border-radius: 5px;
            width: 100%;
            max-width: 100px;
            text-align: center;
            color: #6C5400;
            transition: all 0.2s ease-in-out;
        }

        .editable:focus {
            box-shadow: 0 0 0 3px rgba(255, 204, 102, 0.3); /* Softer yellow shadow on focus */
            border-color: #FFCC66;
        }
        
        .calculated {
            background-color: #EBF8E8; /* Softer green */
            color: #1A7036;
            font-weight: 600;
            padding: 8px;
            border-radius: 5px;
            /* Removed display: inline-block; min-width; text-align; from here */
        }
        
        .total-row {
            background-color: #F0F4FA; /* Light blue for totals */
            font-weight: bold;
        }
        
        .summary-section .section-header {
            background: #6A5ACD; /* A darker accent for summary header */
        }

        .summary-section table {
            table-layout: fixed; /* Ensures columns take equal width or specified widths */
            width: 100%;
        }

        /* Specific column widths for summary table for better print layout */
        .summary-section table th:nth-child(1) { width: 18%; } /* Category */
        .summary-section table th:nth-child(2) { width: 32%; } /* Description */
        .summary-section table th:nth-child(3) { width: 18%; } /* Cost per m³ */
        .summary-section table th:nth-child(4) { width: 18%; } /* Project Total */
        .summary-section table th:nth-child(5) { width: 14%; } /* Percentage */


        .summary-section table th,
        .summary-section table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #E0E6ED; /* General border for all table cells */
        }

        .summary-section table th {
            background-color: #7E74D4; /* Slightly different shade for summary header */
            color: white;
        }

        /* Styles for summary table cells (display mode) */
        /* These rules are for SCREEN display mode only */
        .summary-section tbody td {
            padding: 0; /* Remove padding from cell itself */
            vertical-align: middle; /* Vertically align content in the middle */
        }
        
        .summary-section tbody td > div {
            display: flex; /* Use flexbox for content within the div */
            justify-content: flex-end; /* Align content to the right */
            align-items: center; /* Vertically center content */
            width: 100%; /* Take full width of the cell */
            height: 100%; /* Take full height of the cell */
            padding: 12px; /* Apply padding here instead of td */
            box-sizing: border-box; /* Include padding in width/height */
            white-space: nowrap; /* Prevent wrapping */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Add ellipsis */
            color: #333333; /* Default dark color */
        }

        /* Specifically align description in summary table to left (display mode) */
        .summary-section tbody td:nth-child(2) > div {
            justify-content: flex-start; /* Align description to the left */
        }

        /* Adjustments for Percentage column in summary table (display mode) */
        .summary-section td.calculated[id$="_percentage"] > div {
            justify-content: flex-end; /* Align percentage to the right */
            font-weight: bold;
        }

        /* Override for total row calculated values in summary table (display mode) */
        .summary-section .total-row td > div {
            color: #1A202C; /* Changed from white to a very dark gray for better contrast */
        }
        
        .cost-per-cubic {
            background: linear-gradient(135deg, #1ABC9C, #2ECC71); /* Green gradient */
            color: white;
            padding: 25px;
            text-align: center;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        
        .cost-per-cubic h2 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .cost-per-cubic .amount {
            font-size: 3.2em;
            font-weight: bold;
            margin: 10px 0;
            letter-spacing: -1px;
        }
        
        .btn {
            background: linear-gradient(135deg, #4A90E2, #6A5ACD);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(74, 144, 226, 0.3);
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 0.9em;
        }
        
        .alert-info {
            background: #E0F2F7; /* Lighter blue info alert */
            border: 1px solid #BEEBF9;
            color: #0A608F;
        }

        /* Styles for disabled rows/inputs */
        .disabled-row {
            opacity: 0.6; /* Dim the row */
            background-color: #f5f5f5; /* Slightly different background */
        }

        .disabled-row input[type="number"],
        .disabled-row select {
            background-color: #e0e0e0; /* Gray out disabled inputs */
            cursor: not-allowed;
        }
        
        /* Checkbox styling */
        .use-checkbox {
            margin-left: 10px; /* Space between checkbox and text */
            transform: scale(1.2); /* Slightly larger checkbox */
            cursor: pointer;
            vertical-align: middle;
        }

        /* Print-specific styles */
        @media print {
            body {
                background-color: #fff;
                padding: 0;
                margin: 0;
                font-family: 'Inter', sans-serif;
            }
            .container {
                box-shadow: none;
                max-width: 100%;
            }
            .header, .project-input, .section, .cost-per-cubic {
                box-shadow: none;
                border-radius: 0;
                margin-bottom: 10px; /* Less space between sections */
                padding: 10px; /* Less padding for sections */
            }
            .header h1 {
                -webkit-print-color-adjust: exact; /* Ensure gradient prints */
                color: #2C3E50; /* Fallback for older browsers */
                font-size: 2em; /* Adjust font size for print */
                gap: 5px; /* Adjust gap for print */
            }
            .section-header {
                -webkit-print-color-adjust: exact; /* Ensure background prints */
                background: #4A90E2 !important; /* Force background print */
                color: white !important;
                border-radius: 0;
                margin: -10px -10px 10px -10px; /* Adjust negative margin for print */
                padding: 10px;
                font-size: 1.1em; /* Adjust font size for print */
                gap: 5px; /* Adjust gap for print */
            }
            .alert, .print-button, .use-checkbox, 
            .input-group input:not([readonly]):not([type="checkbox"]), /* Hide editable inputs but not read-only or checkboxes */
            .input-group select {
                display: none !important; /* Hide alerts, buttons, checkboxes, and editable inputs */
            }

            /* Show read-only inputs for print */
            .input-group input[readonly] {
                display: block !important;
                background-color: transparent !important;
                border: none !important;
                padding: 0 !important;
                box-shadow: none !important;
                color: #000 !important; /* Ensure black text */
                text-align: left !important; /* Align to left */
                width: auto !important; /* Allow content to dictate width */
                max-width: none !important; /* Remove max-width constraint */
            }

            /* Show labels for read-only inputs in print */
            .input-group label {
                font-weight: bold;
                color: #000;
                display: block !important; /* Ensure labels are block level for print */
                margin-bottom: 0px !important; /* Reduce space after labels */
            }
            
            /* Ensure calculated values and read-only elements are visible */
            .calculated {
                display: block !important; /* Change to block for consistent layout in print */
                background-color: transparent !important;
                border: none !important;
                padding: 0 !important;
                box-shadow: none !important;
                color: #000 !important; /* Ensure black text */
                text-align: right !important; /* Keep right alignment for numbers */
                width: auto !important; /* Allow content to dictate width */
            }

            /* REMOVED: Styles for div inside td within summary table for print */
            /* These rules should no longer be needed as the div is removed from HTML for print summary table */
            /* .summary-section tbody td > div { ... } */


            /* Tables */
            table {
                break-inside: avoid; /* Avoid breaking tables across pages */
                page-break-inside: avoid; /* For older browsers */
                width: 100%; /* Ensure table takes full width */
            }
            /* Avoid page breaks inside table rows */
            table tr {
                page-break-inside: avoid !important; /* Force rows to stay together */
                break-inside: avoid !important; /* For newer browsers */
            }

            /* Force sections to avoid breaking, keeping header with its content */
            .section {
                page-break-inside: avoid !important;
                page-break-before: auto !important; /* Allow break before if it fits, otherwise push to next page */
                break-inside: avoid !important;
            }

            th, td {
                border-color: #ccc !important; /* Lighter borders for print */
                padding: 8px !important; /* Uniform padding for print */
                vertical-align: top !important; /* Align content to top within cell */
                color: #000 !important; /* Ensure text is black for print */
            }

            /* Header specific alignment for print */
            .summary-section table th {
                text-align: center !important; /* Center align headers as seen in image */
                background-color: #7E74D4 !important; /* Maintain original summary header color for print */
                color: white !important;
            }

            /* Apply explicit widths and text-align directly to td for print */
            .summary-section table th:nth-child(1) { width: 18% !important; } /* Category */
            .summary-section table td:nth-child(1) { width: 18% !important; text-align: left !important; }

            .summary-section table th:nth-child(2) { width: 32% !important; } /* Description */
            .summary-section table td:nth-child(2) { width: 32% !important; text-align: left !important; white-space: normal !important; } /* Allow wrapping for description */

            .summary-section table th:nth-child(3) { width: 18% !important; } /* Cost per m³ */
            .summary-section table td:nth-child(3) { width: 18% !important; text-align: right !important; }

            .summary-section table th:nth-child(4) { width: 18% !important; } /* Project Total */
            .summary-section table td:nth-child(4) { width: 18% !important; text-align: right !important; }

            .summary-section table th:nth-child(5) { width: 14% !important; } /* Percentage */
            .summary-section table td:nth-child(5) { width: 14% !important; text-align: right !important; }

            /* Material Quantity Summary Print Styles */
            #material_qty_summary_tbody th:nth-child(1),
            #material_qty_summary_tbody td:nth-child(1) {
                width: 40% !important; /* Material Name */
                text-align: left !important;
            }
            #material_qty_summary_tbody th:nth-child(2),
            #material_qty_summary_tbody td:nth-child(2) {
                width: 30% !important; /* Qty per m³ */
                text-align: right !important;
            }
            #material_qty_summary_tbody th:nth-child(3),
            #material_qty_summary_tbody td:nth-child(3) {
                width: 30% !important; /* Total Quantity */
                text-align: right !important;
            }


            /* Ensure total row text color is black and follows alignment */
            .summary-section .total-row td {
                color: #000 !important; /* Ensure total text is black */
                font-weight: bold !important; /* Keep bold for totals */
            }
            /* As the div is removed, no specific rule for div within total-row td is needed. Text is directly in td. */


            /* Specific fix for Project Name display in print */
            .print-only-project-name {
                display: block !important; /* Show for print */
                font-size: 1.5em; /* Larger font for project name */
                font-weight: bold;
                color: #000;
                margin-bottom: 10px;
                text-align: center;
            }
            .project-name-input-group {
                display: none !important; /* Hide the input group for project name */
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>3D Printed Concrete - Universal Cost Calculator</h1> <!-- Removed icon span -->
            <div class="company-info">
                PT. ICONIC LIVIN DEVELOPMENT<br> <!-- Corrected spelling -->
                Jl. Dewi Sri No.18, Legian, Kuta, Badung - Bali
            </div>
        </div>

        <!-- Project Input Section -->
        <div class="project-input">
            <h3>🏗️ Project Parameters</h3>
            <!-- Group 1: Project Basic Info -->
            <div class="input-grid">
                <div class="input-group project-name-input-group"> <!-- Added class for print hiding -->
                    <label for="project_name">Project Name</label>
                    <input type="text" id="project_name" placeholder="Enter project name" value="Sample Project" onkeyup="updateProjectNameForPrint()"> <!-- Added onkeyup -->
                </div>
                <span id="print_project_name" class="print-only-project-name" style="display: none;"></span> <!-- Element to display project name for print -->
                <div class="input-group">
                    <label for="structure_type">Structure Type</label>
                    <select id="structure_type" onchange="calculateAll()">
                        <option value="wall">Wall</option>
                        <option value="column">Column</option>
                        <option value="beam">Beam</option>
                        <option value="slab">Slab</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
            </div>

            <!-- Group 2: Volume Calculation -->
            <div class="input-grid mt-4">
                <div class="input-group">
                    <label for="length_mm">Length (mm)</label>
                    <input type="number" id="length_mm" value="4330" step="10" onchange="calculateAll()">
                </div>
                <div class="input-group">
                    <label for="width_mm">Width (mm)</label>
                    <input type="number" id="width_mm" value="170" step="10" onchange="calculateAll()">
                </div>
                <div class="input-group">
                    <label for="height_mm">Height (mm)</label>
                    <input type="number" id="height_mm" value="2000" step="10" onchange="calculateAll()">
                </div>
            </div>

            <!-- Group 3: Total Volume, Duration, Operating Hours -->
            <div class="input-grid mt-4">
                <div class="input-group">
                    <label for="total_volume">Total Volume (m³)</label>
                    <input type="number" id="total_volume" value="1.00" readonly> <!-- Now read-only -->
                </div>
                <div class="input-group">
                    <label for="project_duration">Project Duration (days)</label>
                    <input type="number" id="project_duration" value="1" readonly> <!-- Made readonly -->
                    <span class="text-xs text-gray-500" id="project_duration_hours_minutes"></span> <!-- Added display for hours and minutes -->
                </div>
                <div class="input-group">
                    <label for="daily_operating_hours">Printer (Hours)</label> <!-- Shortened label -->
                    <input type="number" id="daily_operating_hours" value="8" step="1" min="1" max="24" onchange="calculateAll()">
                </div>
            </div>

            <!-- Group 4: Nozzle Dimensions -->
            <div class="input-grid mt-4">
                <div class="input-group">
                    <label for="nozzle_width">Nozzle Width (mm)</label>
                    <input type="number" id="nozzle_width" value="40" step="1" onchange="calculateAll()">
                </div>
                <div class="input-group">
                    <label for="nozzle_height">Nozzle Height (mm)</label>
                    <input type="number" id="nozzle_height" value="20" step="1" onchange="calculateAll()">
                </div>
            </div>

            <div class="alert alert-info" style="margin-top: 20px;">
                <strong>ℹ️ Note:</strong> Total Volume (m³) is calculated from Length, Width, and Height. Project Duration is automatically calculated based on Total Volume and Daily Operating Hours **for the Printer** (assuming 0.2 m³ material takes 1 hour).
            </div>
        </div>

        <!-- Detailed Printing Geometry Section -->
        <div class="section">
            <div class="section-header">📐 Detailed Printing Geometry (for Ink Cost & Volume Reference)</div>
            <div class="input-grid">
                <div class="input-group">
                    <label for="ink_width_mm">Ink Width (mm)</label>
                    <input type="number" id="ink_width_mm" value="40" step="1" onchange="calculateAll()">
                </div>
                <div class="input-group">
                    <label for="ink_thickness_mm">Ink Thickness (mm)</label>
                    <input type="number" id="ink_thickness_mm" value="20" step="1" onchange="calculateAll()">
                </div>
                <div class="input-group">
                    <label for="contour_length_per_layer_mm">Contour Length per Layer (mm)</label>
                    <input type="number" class="editable" value="1500" step="10" onchange="calculateAll()" id="contour_length_per_layer_mm"> <!-- Added ID and onchange -->
                </div>
                <div class="input-group">
                    <label for="layer_amount">Total Layer Amount</label>
                    <input type="number" class="editable" value="27" step="1" onchange="calculateAll()" id="layer_amount"> <!-- Added ID and onchange -->
                </div>
                <div class="input-group">
                    <label>Total Extrusion Length (m)</label>
                    <div class="calculated" id="total_extrusion_length_m">0 m</div>
                </div>
                <div class="input-group">
                    <label>Calculated Volume from Geometry (m³)</label>
                    <div class="calculated" id="calculated_volume_m3">0 m³</div>
                </div>
                <!-- Independent Ink Extrusion Cost -->
                <div class="input-group">
                    <label for="ink_extrusion_cost_per_meter">Cost per Meter Extrusion (Rp/m)</label>
                    <input type="number" class="editable" value="15000" step="1" onchange="calculateAll()" id="ink_extrusion_cost_per_meter">
                </div>
                <div class="input-group">
                    <label>Total Ink Extrusion Cost (Rp)</label>
                    <div class="calculated" id="ink_extrusion_total_cost">Rp 0</div>
                </div>
            </div>
            <div class="alert alert-info" style="margin-top: 20px;">
                <strong>ℹ️ Note:</strong> The "Total Volume (m³)" above is the main input for the overall project. Geometry parameters here are used to calculate ink cost more detailed and provide an alternative volume estimate based on layer dimensions. **This Total Ink Extrusion Cost is for reference and is NOT included in the project total.**
            </div>
        </div>

        <!-- Material Batch Reference Section -->
        <div class="section">
            <div class="section-header">📚 Referensi Komposisi Material Per Batch</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Qty (Kg/L)</th>
                            <th>Volume (m³)</th>
                            <th>Cost (IDR)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Ink Powder</td>
                            <td>20 Kg</td>
                            <td>0.04</td>
                            <td>192.000</td>
                        </tr>
                        <tr>
                            <td>Portland Cement</td>
                            <td>20 Kg</td>
                            <td>0.03</td>
                            <td>27.500</td>
                        </tr>
                        <tr>
                            <td>River Sand</td>
                            <td>60 Kg</td>
                            <td>0.03</td>
                            <td>525.000</td>
                        </tr>
                        <tr>
                            <td>Plastic/Tarpaulin</td>
                            <td>2 Unit</td>
                            <td>N/A</td>
                            <td>19.200</td>
                        </tr>
                        <tr>
                            <td>Water</td>
                            <td>13 L</td>
                            <td>0.05</td>
                            <td>18.200</td>
                        </tr>
                        <tr class="total-row">
                            <td><strong>Total per Batch</strong></td>
                            <td></td>
                            <td>~0.15</td>
                            <td>781.900</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="alert alert-info" style="margin-top: 20px;">
                <strong>💡 Note:</strong> This table is a fixed reference for the composition of 1 material batch. Material costs in the "Raw Materials" section are calculated based on the project volume input you provide.
            </div>
        </div>

        <!-- Material Quantity Summary Section -->
        <div class="section">
            <div class="section-header">⚖️ Material Quantity Summary (Per Project)</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Qty per m³ (from input)</th>
                            <th>Total Quantity (Kg/Unit)</th>
                        </tr>
                    </thead>
                    <tbody id="material_qty_summary_tbody">
                        <!-- Content will be generated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="alert alert-info" style="margin-top: 20px;">
                <strong>💡 Note:</strong> Total quantities are calculated based on your project volume. Use this to estimate logistics and procurement needs.
            </div>
        </div>

        <!-- Printer Selection Section -->
        <div class="section">
            <div class="section-header">🖨️ 3D Printer Selection & Equipment Rental</div>
            <div class="printer-selection">
                <h4 style="margin-bottom: 15px; color: #2c3e50;">Select Printer Brand & Rental Option:</h4>
                <div class="printer-cards" id="printer_cards">
                    <!-- Printer cards will be generated by JavaScript -->
                </div>
                <div class="alert alert-info" id="selected_printer_feedback" style="margin-top: 15px;">
                    Currently selected: None
                </div>
                
                <div class="alert alert-info">
                    <strong>💡 Rental Information:</strong> Prices include operator training and basic maintenance. Purchase options include 5-year warranty and full technical support.
                </div>
            </div>
        </div>

        <!-- Materials Section -->
        <div class="section">
            <div class="section-header">🧱 Raw Materials (Per Project Volume)</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Description</th>
                            <th>Qty per m³ (editable)</th>
                            <th>Price per Unit (Rp)</th>
                            <th>Use</th> <!-- Added "Use" column header -->
                            <th>Total Cost (Rp)</th>
                        </tr>
                    </thead>
                    <tbody id="materials_tbody">
                        <tr>
                            <td>Ink Powder</td>
                            <td>Cost: $600/ton (~9600 IDR/Kg)</td>
                            <td><input type="number" class="editable" data-cost-type="material-qty" value="125" step="0.1" onchange="calculateAll()" id="ink_powder_qty_per_m3"> Kg/m³</td>
                            <td><input type="number" class="editable" data-cost-type="material-price" value="9600" onchange="calculateAll()" id="ink_powder_price_per_kg"> Rp/Kg</td>
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="ink_cost"></td>
                        </tr>
                        <tr>
                            <td>Portland Cement</td>
                            <td>Merk Singa Merah</td>
                            <td><input type="number" class="editable" data-cost-type="material-qty" value="125" step="0.1" onchange="calculateAll()" id="cement_qty_per_m3"> Kg/m³</td>
                            <td><input type="number" class="editable" data-cost-type="material-price" value="1375" onchange="calculateAll()" id="cement_price_per_kg"> Rp/Kg</td>
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="cement_cost"></td>
                        </tr>
                        <tr>
                            <td>River Sand</td>
                            <td>From Karangasem</td>
                            <td><input type="number" class="editable" data-cost-type="material-qty" value="375" step="0.1" onchange="calculateAll()" id="sand_qty_per_m3"> Kg/m³</td>
                            <td><input type="number" class="editable" data-cost-type="material-price" value="8750" onchange="calculateAll()" id="sand_price_per_kg"> Rp/Kg</td>
                            <td><input type="checkbox" class="use-checkbox" data-target-inputs=".material-sand-inputs" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="sand_cost"></td>
                        </tr>
                        <tr>
                            <td>Plastic/Tarpaulin</td>
                            <td>10% Unit/cost</td>
                            <td><input type="number" class="editable" data-cost-type="material-qty" value="12.5" step="0.1" onchange="calculateAll()" id="plastic_qty_per_unit"> Unit/m³</td>
                            <td><input type="number" class="editable" data-cost-type="material-price" value="9600" onchange="calculateAll()" id="plastic_price_per_unit"> Rp/Unit</td>
                            <td><input type="checkbox" class="use-checkbox" data-target-inputs=".material-plastic-inputs" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="plastic_cost"></td>
                        </tr>
                        <tr>
                            <td>Water</td>
                            <td>Clean Water</td>
                            <td><input type="number" class="editable" data-cost-type="material-qty" value="81.25" step="0.01" onchange="calculateAll()" id="water_qty_per_m3"> L/m³</td>
                            <td><input type="number" class="editable" data-cost-type="material-price" value="1400" onchange="calculateAll()" id="water_price_per_l"> Rp/L</td>
                            <td><input type="checkbox" class="use-checkbox" data-target-inputs=".material-water-inputs" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="water_cost"></td>
                        </tr>
                        <tr class="total-row">
                            <td colspan="5"><strong>Total Materials per m³</strong></td> <!-- colspan adjusted for new column -->
                            <td class="calculated" id="materials_total"></td>
                        </tr>
                    </tbody>
                </table>
                <button type="button" class="btn add-item-button" onclick="addMaterialRow()">+ Add Material</button>
            </div>
        </div>

        <!-- Reinforcement Section -->
        <div class="section">
            <div class="section-header">🔧 Sub Materials - Reinforcing Bar</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Diameter</th>
                            <th>Description</th>
                            <th>Total Length (m)</th> <!-- Updated column header -->
                            <th>Unit</th>
                            <th>Price per Meter (Rp)</th> <!-- Updated column header -->
                            <th>Use</th>
                            <th>Total Cost (Rp)</th>
                        </tr>
                    </thead>
                    <tbody id="rebar_tbody">
                        <tr>
                            <td>D 6mm</td>
                            <td>Reinforcing bar</td>
                            <td><input type="number" class="editable" data-cost-type="rebar-length" value="12" step="0.1" onchange="calculateAll()" id="d6_length"></td> <!-- input for length -->
                            <td>Meter</td>
                            <td><input type="number" class="editable" data-cost-type="rebar-price-per-meter" value="5000" onchange="calculateAll()" id="d6_price"></td> <!-- input for price per meter -->
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="d6_cost"></td> <!-- Now automated total -->
                        </tr>
                        <tr>
                            <td>D 8mm</td>
                            <td>Reinforcing bar</td>
                            <td><input type="number" class="editable" data-cost-type="rebar-length" value="12" step="0.1" onchange="calculateAll()" id="d8_length"></td>
                            <td>Meter</td>
                            <td><input type="number" class="editable" data-cost-type="rebar-price-per-meter" value="5000" onchange="calculateAll()" id="d8_price"></td>
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="d8_cost"></td>
                        </tr>
                        <tr>
                            <td>D 10mm</td>
                            <td>Reinforcing bar</td>
                            <td><input type="number" class="editable" data-cost-type="rebar-length" value="12" step="0.1" onchange="calculateAll()" id="d10_length"></td>
                            <td>Meter</td>
                            <td><input type="number" class="editable" data-cost-type="rebar-price-per-meter" value="6500" onchange="calculateAll()" id="d10_price"></td>
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="d10_cost"></td>
                        </tr>
                        <tr>
                            <td>D 12mm</td>
                            <td>Reinforcing bar</td>
                            <td><input type="number" class="editable" data-cost-type="rebar-length" value="12" step="0.1" onchange="calculateAll()" id="d12_length"></td>
                            <td>Meter</td>
                            <td><input type="number" class="editable" data-cost-type="rebar-price-per-meter" value="12700" onchange="calculateAll()" id="d12_price"></td>
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="d12_cost"></td>
                        </tr>
                        <tr>
                            <td>D 16mm</td>
                            <td>Reinforcing bar</td>
                            <td><input type="number" class="editable" data-cost-type="rebar-length" value="12" step="0.1" onchange="calculateAll()" id="d16_length"></td>
                            <td>Meter</td>
                            <td><input type="number" class="editable" data-cost-type="rebar-price-per-meter" value="12400" onchange="calculateAll()" id="d16_price"></td>
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="d16_cost"></td>
                        </tr>
                        <tr>
                            <td>D 22mm</td>
                            <td>Reinforcing bar</td>
                            <td><input type="number" class="editable" data-cost-type="rebar-length" value="12" step="0.1" onchange="calculateAll()" id="d22_length"></td>
                            <td>Meter</td>
                            <td><input type="number" class="editable" data-cost-type="rebar-price-per-meter" value="15000" onchange="calculateAll()" id="d22_price"></td>
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="d22_cost"></td>
                        </tr>
                        <tr class="total-row">
                            <td colspan="6"><strong>Total Reinforcement Cost</strong></td> <!-- Adjusted label -->
                            <td class="calculated" id="rebar_total"></td>
                        </tr>
                    </tbody>
                </table>
                <button type="button" class="btn add-item-button" onclick="addRebarRow()">+ Add Rebar Type</button>
            </div>
        </div>

        <!-- Equipment & Rentals Section -->
        <div class="section">
            <div class="section-header">🚚 Additional Equipment & Rentals</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Equipment Description</th>
                            <th>Duration (Units)</th>
                            <th>Unit Type</th>
                            <th>Rate per Unit (Rp)</th>
                            <th>Use</th> <!-- Added "Use" column header -->
                            <th>Total Cost (Rp)</th>
                        </tr>
                    </thead>
                    <tbody id="equipment_tbody">
                        <tr class="subheader-row">
                            <td colspan="6" style="background-color: #F0F4FA; font-weight: bold; text-align: center;">Distribution</td> <!-- colspan adjusted -->
                        </tr>
                        <tr>
                            <td>Mobile Crane Rental</td>
                            <td><input type="number" class="editable" data-cost-type="equipment-qty" value="8" onchange="calculateAll()" id="crane_qty"></td>
                            <td>Hours</td>
                            <td><input type="number" class="editable" data-cost-type="equipment-rate" value="812500" onchange="calculateAll()" id="crane_rate"></td>
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="crane_cost"></td>
                        </tr>
                        <tr>
                            <td>Flat Deck Truck Rental</td>
                            <td><input type="number" class="editable" data-cost-type="equipment-qty" value="8" onchange="calculateAll()" id="truck_qty"></td>
                            <td>Hours</td>
                            <td><input type="number" class="editable" data-cost-type="equipment-rate" value="375000" onchange="calculateAll()" id="truck_rate"></td>
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="truck_cost"></td>
                        </tr>
                        <tr>
                            <td>Pickup/Truck Rental</td>
                            <td><input type="number" class="editable" data-cost-type="equipment-qty" value="1" onchange="calculateAll()" id="pickup_qty"></td>
                            <td>Trip</td>
                            <td><input type="number" class="editable" data-cost-type="equipment-rate" value="450000" onchange="calculateAll()" id="pickup_rate"></td>
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="pickup_cost"></td>
                        </tr>
                        <tr class="subheader-row">
                            <td colspan="6" style="background-color: #F0F4FA; font-weight: bold; text-align: center;">Tools</td> <!-- colspan adjusted -->
                        </tr>
                        <tr>
                            <td>Concrete Mixer Rental (manual casting)</td>
                            <td><input type="number" class="editable" data-cost-type="equipment-qty" value="24" onchange="calculateAll()" id="mixer_qty"></td>
                            <td>Hours</td>
                            <td><input type="number" class="editable" data-cost-type="equipment-rate" value="20833" onchange="calculateAll()" id="mixer_rate"></td>
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="mixer_cost"></td>
                        </tr>
                        <tr>
                            <td>Compressor for Equipment Rental</td>
                            <td><input type="number" class="editable" data-cost-type="equipment-qty" value="24" onchange="calculateAll()" id="compressor_qty"></td>
                            <td>Hours</td>
                            <td><input type="number" class="editable" data-cost-type="equipment-rate" value="8333" onchange="calculateAll()" id="compressor_rate"></td>
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="compressor_cost"></td>
                        </tr>
                        <tr>
                            <td>Angle Grinder</td>
                            <td><input type="number" class="editable" data-cost-type="equipment-qty" value="24" onchange="calculateAll()" id="grinder_qty"></td>
                            <td>Hours</td>
                            <td><input type="number" class="editable" data-cost-type="equipment-rate" value="8333" onchange="calculateAll()" id="grinder_rate"></td>
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="grinder_cost"></td>
                        </tr>
                        <tr>
                            <td>Brushless Drill</td>
                            <td><input type="number" class="editable" data-cost-type="equipment-qty" value="1" onchange="calculateAll()" id="drill_qty"></td>
                            <td>Unit</td>
                            <td><input type="number" class="editable" data-cost-type="equipment-rate" value="100000" onchange="calculateAll()" id="drill_rate"></td>
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="drill_cost"></td>
                        </tr>
                        <tr class="subheader-row">
                            <td colspan="6" style="background-color: #F0F4FA; font-weight: bold; text-align: center;">Other Sub-Rentals & Consumables</td> <!-- colspan adjusted -->
                        </tr>
                        <tr>
                            <td>Fuel & Power Consumption</td>
                            <td><input type="number" class="editable" data-cost-type="equipment-qty" value="24" onchange="calculateAll()" id="fuel_qty"></td>
                            <td>Hours</td>
                            <td><input type="number" class="editable" data-cost-type="equipment-rate" value="12500" onchange="calculateAll()" id="fuel_rate"></td>
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="fuel_cost"></td>
                        </tr>
                        <tr class="total-row">
                            <td colspan="5"><strong>Subtotal Equipment</strong></td> <!-- colspan adjusted -->
                            <td class="calculated" id="equipment_total"></td>
                        </tr>
                    </tbody>
                </table>
                <button type="button" class="btn add-item-button" onclick="addEquipmentRow()">+ Add Equipment</button>
            </div>
        </div>

        <!-- Labor Section -->
        <div class="section">
            <div class="section-header">👷 Labor Cost</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Time (Minutes/Day)</th> <!-- Re-added Time (Minutes/Day) column -->
                            <th>Rate per Hour (Rp)</th> <!-- Reverted to Rate per Hour -->
                            <th>Use</th> <!-- Added "Use" column header -->
                            <th>Total Cost (Rp)</th>
                        </tr>
                    </thead>
                    <tbody id="labor_tbody">
                        <tr>
                            <td>Field Workers</td>
                            <td>250K IDR / 8 Hours</td>
                            <td><input type="number" class="editable" data-cost-type="labor-qty" value="2" onchange="calculateAll()" id="workers_qty"></td>
                            <td><input type="number" class="editable" data-cost-type="labor-time" value="480" onchange="calculateAll()" id="workers_time"></td> <!-- Re-added time input -->
                            <td><input type="number" class="editable" data-cost-type="labor-rate" value="31250" onchange="calculateAll()" id="workers_rate"></td> <!-- Changed data-cost-type to labor-rate -->
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="workers_cost"></td>
                        </tr>
                        <tr>
                            <td>Supervisor</td>
                            <td>500K IDR / 8 Hours</td>
                            <td><input type="number" class="editable" data-cost-type="labor-qty" value="1" onchange="calculateAll()" id="supervisor_qty"></td>
                            <td><input type="number" class="editable" data-cost-type="labor-time" value="480" onchange="calculateAll()" id="supervisor_time"></td> <!-- Re-added time input -->
                            <td><input type="number" class="editable" data-cost-type="labor-rate" value="62500" onchange="calculateAll()" id="supervisor_rate"></td> <!-- Changed data-cost-type to labor-rate -->
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="supervisor_cost"></td>
                        </tr>
                        <tr>
                            <td>Daily Workers (Load/Unload)</td>
                            <td>Additional labor for specific tasks</td>
                            <td><input type="number" class="editable" data-cost-type="labor-qty" value="0" onchange="calculateAll()" id="daily_workers_qty"></td>
                            <td><input type="number" class="editable" data-cost-type="labor-time" value="480" onchange="calculateAll()" id="daily_workers_time"></td> <!-- Re-added time input for Daily Workers -->
                            <td><input type="number" class="editable" data-cost-type="labor-rate" value="25000" onchange="calculateAll()" id="daily_workers_rate"></td> <!-- Reverted to labor-rate -->
                            <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                            <td class="calculated" id="daily_workers_cost"></td>
                        </tr>
                        <tr class="total-row">
                            <td colspan="6"><strong>Total Labor Cost</strong></td> <!-- colspan adjusted -->
                            <td class="calculated" id="labor_total"></td>
                        </tr>
                    </tbody>
                </table>
                <button type="button" class="btn add-item-button" onclick="addLaborRow()">+ Add Labor Position</button>
            </div>
        </div>

        <!-- Cost per Cubic Meter -->
        <div class="cost-per-cubic">
            <h2>💰 Cost per Cubic Meter (m³)</h2>
            <div class="amount" id="cost_per_cubic">Rp 0</div>
            <p>Total project volume: <span id="display_volume">1.00</span> m³</p>
        </div>

        <!-- Final Summary -->
        <div class="section summary-section">
            <div class="section-header">📊 Project Cost Summary</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Cost per m³ (Rp)</th>
                            <th>Project Total (Rp)</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody id="summary_tbody">
                        <tr>
                            <td>3D Printer</td>
                            <td id="selected_printer_summary">Not Selected</td>
                            <td class="calculated" id="printer_per_cubic">0</td>
                            <td class="calculated" id="printer_project_total">0</td>
                            <td class="calculated" id="printer_percentage">0%</td>
                        </tr>
                        <tr>
                            <td>Equipment & Rentals</td>
                            <td>Additional equipment and tools</td>
                            <td class="calculated" id="equipment_per_cubic">0</td>
                            <td class="calculated" id="equipment_project_total">0</td>
                            <td class="calculated" id="equipment_percentage">0%</td>
                        </tr>
                        <tr>
                            <td>Raw Materials</td>
                            <td>Concrete mix components</td>
                            <td class="calculated" id="materials_per_cubic">0</td>
                            <td class="calculated" id="materials_project_total">0</td>
                            <td class="calculated" id="materials_percentage">0%</td>
                        </tr>
                        <tr>
                            <td>Labor</td>
                            <td>Workers and supervision</td>
                            <td class="calculated" id="labor_per_cubic">0</td>
                            <td class="calculated" id="labor_project_total">0</td>
                            <td class="calculated" id="labor_percentage">0%</td>
                        </tr>
                        <tr>
                            <td>Reinforcement</td>
                            <td>Steel bars and accessories</td>
                            <td class="calculated" id="rebar_per_cubic">0</td>
                            <td class="calculated" id="rebar_project_total">0</td>
                            <td class="calculated" id="rebar_percentage">0%</td>
                        </tr>
                        <tr class="total-row">
                            <td><strong>PROJECT TOTAL</strong></td>
                            <td><strong>Complete 3D Printed Structure</strong></td>
                            <td class="calculated" id="grand_total_per_cubic">0</td>
                            <td class="calculated" id="grand_total_project">0</td>
                            <td class="calculated" id="grand_total_percentage">100%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <button onclick="window.print()" class="btn print-button">🖨️ Cetak Laporan</button> <!-- Added print button -->
    </div>

    <script>
        // Function to update the hidden span for printing Project Name
        function updateProjectNameForPrint() {
            const projectNameInput = document.getElementById('project_name');
            const printProjectNameSpan = document.getElementById('print_project_name');
            if (projectNameInput && printProjectNameSpan) {
                printProjectNameSpan.textContent = projectNameInput.value;
            }
        }

        // Data for available printers and their rental/purchase options
        const PRINTERS = [
            {
                name: "Win Sun",
                options: [
                    { label: "Hourly Rental (per hour)", rate: 148625, unit: "hour" }, // This is per hour rate
                    { label: "8-Hour Rental (per day)", rate: 3567000 / 3, unit: "8-hour" }, // Corrected: 1/3 of Daily Rental
                    { label: "Daily Rental (24h)", rate: 3567000, unit: "day" },
                    { label: "Monthly Rental", rate: 108520000, unit: "month" },
                    { label: "Yearly Rental", rate: 1302240000, unit: "year" },
                    { label: "Purchase (5 Years)", rate: 6511200000, unit: "one-time" }
                ]
            },
            {
                name: "GearBuild",
                options: [
                    { label: "Hourly Rental (per hour)", rate: 64057, unit: "hour" },
                    { label: "8-Hour Rental (per day)", rate: 1537367 / 3, unit: "8-hour" }, // Corrected: 1/3 of Daily Rental
                    { label: "Daily Rental (24h)", rate: 1537367, unit: "day" }, 
                    { label: "Monthly Rental", rate: 46121000, unit: "month" },
                    { label: "Yearly Rental", rate: 553425000, unit: "year" },
                    { label: "Purchase (5 Years)", rate: 2767260000, unit: "one-time" }
                ]
            },
            {
                name: "SJ",
                options: [
                    { label: "Hourly Rental (per hour)", rate: 29732, unit: "hour" },
                    { label: "8-Hour Rental (per day)", rate: 713556 / 3, unit: "8-hour" }, // Corrected: 1/3 of Daily Rental
                    { label: "Daily Rental (24h)", rate: 713556, unit: "day" },
                    { label: "Monthly Rental", rate: 21704000, unit: "month" },
                    { label: "Yearly Rental", rate: 260448000, unit: "year" },
                    { label: "Purchase (5 Years)", rate: 1302240000, unit: "one-time" }
                ]
            }
        ];

        let selectedPrinter = null;
        let selectedPrinterOption = null;

        // Function to format numbers to Indonesian Rupiah currency
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Function to format quantities (e.g., Kg, L, Unit)
        function formatQuantity(amount, unit) {
            if (typeof amount !== 'number' || isNaN(amount)) {
                return `N/A ${unit}`;
            }
            return `${amount.toFixed(2)} ${unit}`;
        }

        // Function to render printer cards dynamically
        function renderPrinterCards() {
            const printerCardsContainer = document.getElementById('printer_cards');
            printerCardsContainer.innerHTML = ''; // Clear container before re-rendering

            PRINTERS.forEach((printer, printerIndex) => {
                const printerCard = document.createElement('div');
                printerCard.className = 'printer-card';
                // Build pricing options for each printer
                const pricingOptionsHtml = printer.options.map((option, optionIndex) => `
                    <div class="pricing-option" 
                        data-printer-index="${printerIndex}" 
                        data-option-index="${optionIndex}" 
                        onclick="selectPrinter('${printer.name}', ${printerIndex}, ${optionIndex})">
                        <div class="price-amount">${formatRupiah(option.rate)}</div>
                        <div class="price-label">${option.label}</div>
                    </div>
                `).join('');

                printerCard.innerHTML = `
                    <div class="printer-name">${printer.name}</div>
                    <div class="pricing-options">
                        ${pricingOptionsHtml}
                    </div>
                `;
                printerCardsContainer.appendChild(printerCard);
            });
        }

        // Function to select a printer and its pricing option
        function selectPrinter(printerName, printerIndex, optionIndex) {
            // Remove 'selected' class from all pricing options
            const allPrinterOptions = document.querySelectorAll('.pricing-option');
            allPrinterOptions.forEach(option => option.classList.remove('selected'));

            // Add 'selected' class to the chosen pricing option
            const selectedOptionElement = document.querySelector(`.pricing-option[data-printer-index="${printerIndex}"][data-option-index="${optionIndex}"]`);
            selectedOptionElement.classList.add('selected');

            // Remove 'selected' class from all printer cards
            const allPrinterCards = document.querySelectorAll('.printer-card');
            allPrinterCards.forEach(card => card.classList.remove('selected'));
            // Add 'selected' class to the printer card containing the chosen option
            selectedOptionElement.closest('.printer-card').classList.add('selected');

            selectedPrinter = PRINTERS[printerIndex];
            selectedPrinterOption = selectedPrinter.options[optionIndex];
            
            // Update the selected printer feedback display
            document.getElementById('selected_printer_feedback').textContent = `Currently selected: ${selectedPrinter.name} - ${selectedPrinterOption.label}`;

            calculateAll(); // Recalculate all costs after printer selection
        }

        // Function to calculate the 3D printer cost
        function calculatePrinterCost() {
            let total_volume = parseFloat(document.getElementById('total_volume').value) || 0;
            // project_duration_days and daily_operating_hours are used to calculate total_project_hours_needed in calculateAll()
            // and then passed implicitly via that calculation.
            
            let printerCost = 0;
            let printerDescription = "Not Selected";

            if (selectedPrinter && selectedPrinterOption) {
                const rate = selectedPrinterOption.rate;
                const unit = selectedPrinterOption.unit;
                printerDescription = `${selectedPrinter.name} - ${selectedPrinterOption.label}`;

                const volume_per_batch_for_hours = 0.2; // m³ per batch for 1 hour
                const time_per_batch_hours = 1; // 1 hour per batch (from 60 minutes reference)
                let total_project_hours_needed = 0;
                if (total_volume > 0 && volume_per_batch_for_hours > 0) {
                    total_project_hours_needed = (total_volume / volume_per_batch_for_hours) * time_per_batch_hours;
                }


                if (unit === "hour") { // Hourly Rental (per hour)
                    printerCost = rate * total_project_hours_needed;
                } else if (unit === "8-hour") { // 8-Hour Rental (per day) - Convert to per-hour rate and apply to total project hours
                    printerCost = (rate / 8) * total_project_hours_needed;
                } else if (unit === "day") { // Daily Rental (24h) - Convert to per-hour rate (24h basis) and apply to total project hours
                    printerCost = (rate / 24) * total_project_hours_needed;
                } else if (unit === "month") { // Monthly Rental - Convert to per-hour rate (30 days * 24 hours/day)
                    printerCost = (rate / (30 * 24)) * total_project_hours_needed;
                } else if (unit === "year") { // Yearly Rental - Convert to per-hour rate (365 days * 24 hours/day)
                    printerCost = (rate / (365 * 24)) * total_project_hours_needed;
                } else if (unit === "one-time") {
                    printerCost = rate; // Fixed purchase cost
                }
            }

            document.getElementById('selected_printer_summary').textContent = printerDescription;
            return printerCost;
        }

        // Function to calculate additional equipment and rentals cost
        function calculateEquipment() {
            let totalCost = 0;
            const equipmentRows = document.querySelectorAll('#equipment_tbody tr:not(.total-row):not(.subheader-row)'); 

            equipmentRows.forEach(row => {
                const checkbox = row.querySelector('.use-checkbox');
                const calculatedCell = row.querySelector('.calculated'); // Get the calculated cell

                if (!checkbox || checkbox.checked) {
                    const qtyInput = row.querySelector('input[data-cost-type="equipment-qty"]');
                    const rateInput = row.querySelector('input[data-cost-type="equipment-rate"]');
                    
                    let quantity = parseFloat(qtyInput ? qtyInput.value : 0) || 0;
                    let rate = parseFloat(rateInput ? rateInput.value : 0) || 0;
                    
                    const rowTotal = quantity * rate;
                    
                    if (calculatedCell) { // Ensure the element exists before setting textContent
                        calculatedCell.textContent = formatRupiah(rowTotal);
                    }
                    totalCost += rowTotal;
                } else {
                    if (calculatedCell) {
                        calculatedCell.textContent = formatRupiah(0); // Set to 0 if not used
                    }
                }
            });
            document.getElementById('equipment_total').textContent = formatRupiah(totalCost);
            return totalCost;
        }

        // Function to update the independent ink extrusion cost display
        function updateInkExtrusionCostDisplay() {
            const ink_width_mm = parseFloat(document.getElementById('ink_width_mm').value) || 0;
            const ink_thickness_mm = parseFloat(document.getElementById('ink_thickness_mm').value) || 0;
            const contour_length_per_layer_mm = parseFloat(document.getElementById('contour_length_per_layer_mm').value) || 0;
            const layer_amount = parseFloat(document.getElementById('layer_amount').value) || 0;

            const total_extrusion_length_m = (contour_length_per_layer_mm * layer_amount) / 1000; // Convert mm to meters
            document.getElementById('total_extrusion_length_m').textContent = `${total_extrusion_length_m.toFixed(2)} m`;

            // Calculate volume from geometry (for reference)
            const volume_per_meter_extrusion_m3 = (ink_width_mm / 1000) * (ink_thickness_mm / 1000) * 1; // Volume of 1 meter of extrusion in m3
            const calculated_volume_m3 = volume_per_meter_extrusion_m3 * total_extrusion_length_m;
            document.getElementById('calculated_volume_m3').textContent = `${calculated_volume_m3.toFixed(4)} m³`;

            // Calculate and display independent Ink Extrusion Cost
            const inkExtrusionPricePerMeter = parseFloat(document.getElementById('ink_extrusion_cost_per_meter').value) || 0;
            const inkExtrusionTotalCost = inkExtrusionPricePerMeter * total_extrusion_length_m;
            document.getElementById('ink_extrusion_total_cost').textContent = formatRupiah(inkExtrusionTotalCost);
        }

        // Function to calculate raw materials cost (excluding independent ink extrusion)
        function calculateMaterials() {
            let totalCost = 0;
            const total_volume = parseFloat(document.getElementById('total_volume').value) || 0;
            
            const materialRows = document.querySelectorAll('#materials_tbody tr:not(.total-row)');
            const materialQtySummaryTbody = document.getElementById('material_qty_summary_tbody');
            materialQtySummaryTbody.innerHTML = ''; // Clear existing summary rows

            materialRows.forEach(row => {
                const checkbox = row.querySelector('.use-checkbox');
                const calculatedCostCell = row.querySelector('.calculated'); // Get the calculated cost cell
                const materialName = row.querySelector('td:nth-child(1)').textContent.trim(); // Get material name
                const qtyInput = row.querySelector('input[data-cost-type="material-qty"]');
                const unitText = qtyInput ? qtyInput.nextSibling.textContent.trim() : 'Kg/Unit'; // Get unit text (e.g., Kg/m³, Unit/m³)

                if (!checkbox || checkbox.checked) { // Only calculate if checkbox is checked or not present
                    const quantityPerM3 = parseFloat(qtyInput ? qtyInput.value : 0) || 0;
                    const price = parseFloat(row.querySelector('input[data-cost-type="material-price"]').value) || 0;
                    
                    const rowCostTotal = quantityPerM3 * price * total_volume; 
                    
                    if (calculatedCostCell) { // Ensure it exists
                        calculatedCostCell.textContent = formatRupiah(rowCostTotal);
                    }
                    totalCost += rowCostTotal;

                    // Calculate total quantity for Material Quantity Summary, skipping 'Plastic/Tarpaulin'
                    if (materialName !== 'Plastic/Tarpaulin') {
                        const totalQuantity = quantityPerM3 * total_volume;
                        const newQtySummaryRow = document.createElement('tr');
                        newQtySummaryRow.innerHTML = `
                            <td>${materialName}</td>
                            <td>${formatQuantity(quantityPerM3, unitText.split('/')[0].trim())}</td>
                            <td>${formatQuantity(totalQuantity, unitText.split('/')[0].trim())}</td>
                        `;
                        materialQtySummaryTbody.appendChild(newQtySummaryRow);
                    }

                } else {
                    if (calculatedCostCell) {
                        calculatedCostCell.textContent = formatRupiah(0); // Set to 0 if not used
                    }
                    // Add an entry to the quantity summary even if disabled, with 0 quantity, skipping 'Plastic/Tarpaulin'
                    if (materialName !== 'Plastic/Tarpaulin') {
                        const newQtySummaryRow = document.createElement('tr');
                        newQtySummaryRow.classList.add('disabled-row'); // Indicate it's disabled
                        newQtySummaryRow.innerHTML = `
                            <td>${materialName}</td>
                            <td>${formatQuantity(0, unitText.split('/')[0].trim())}</td>
                            <td>${formatQuantity(0, unitText.split('/')[0].trim())}</td>
                        `;
                        materialQtySummaryTbody.appendChild(newQtySummaryRow);
                    }
                }
            });

            // Add total row for material quantity summary
            const materialsTotalQty = calculateMaterialTotalQuantity(); // Calculate combined total for all materials
            const totalQtySummaryRow = document.createElement('tr');
            totalQtySummaryRow.classList.add('total-row');
            totalQtySummaryRow.innerHTML = `
                <td colspan="2"><strong>Total Kuantitas Material</strong></td>
                <td class="calculated" id="all_materials_total_qty">${formatQuantity(materialsTotalQty, 'Kg')}</td>
            `;
            materialQtySummaryTbody.appendChild(totalQtySummaryRow);


            document.getElementById('materials_total').textContent = formatRupiah(totalCost);
            return totalCost;
        }

        // New function to calculate total quantity of materials (sum of all Kgs/Units)
        function calculateMaterialTotalQuantity() {
            let totalCombinedQuantity = 0;
            const total_volume = parseFloat(document.getElementById('total_volume').value) || 0;

            const materialRows = document.querySelectorAll('#materials_tbody tr:not(.total-row)');
            materialRows.forEach(row => {
                const checkbox = row.querySelector('.use-checkbox');
                if (!checkbox || checkbox.checked) {
                    const materialName = row.querySelector('td:nth-child(1)').textContent.trim();
                    const qtyInput = row.querySelector('input[data-cost-type="material-qty"]');
                    const quantityPerM3 = parseFloat(qtyInput ? qtyInput.value : 0) || 0;
                    
                    // Only include in the total quantity if it's NOT Plastic/Tarpaulin
                    if (materialName !== 'Plastic/Tarpaulin') {
                        totalCombinedQuantity += (quantityPerM3 * total_volume);
                    }
                }
            });
            return totalCombinedQuantity;
        }


        // Function to calculate labor cost
        function calculateLabor() {
            let totalCost = 0;
            const laborRows = document.querySelectorAll('#labor_tbody tr:not(.total-row)');
            // Use project duration in days for labor cost calculation
            let project_duration = parseFloat(document.getElementById('project_duration').value) || 0;

            laborRows.forEach(row => {
                const checkbox = row.querySelector('.use-checkbox');
                const calculatedCell = row.querySelector('.calculated'); // Get the calculated cell

                if (!checkbox || checkbox.checked) { // Only calculate if checkbox is checked or not present
                    const qtyInput = row.querySelector('input[data-cost-type="labor-qty"]');
                    const timeInput = row.querySelector('input[data-cost-type="labor-time"]');
                    const rateInput = row.querySelector('input[data-cost-type="labor-rate"]');

                    let quantity = parseFloat(qtyInput ? qtyInput.value : 0) || 0;
                    let timePerDayMinutes = parseFloat(timeInput ? timeInput.value : 0) || 0;
                    let ratePerHour = parseFloat(rateInput ? rateInput.value : 0) || 0;
                    
                    const hoursPerDay = timePerDayMinutes / 60;
                    const dailyCostPerPerson = hoursPerDay * ratePerHour;
                    const projectTotalCost = quantity * dailyCostPerPerson * project_duration; // Multiply by project_duration (days)

                    if (calculatedCell) { // Ensure the element exists
                        calculatedCell.textContent = formatRupiah(projectTotalCost);
                    }
                    totalCost += projectTotalCost;
                } else {
                    if (calculatedCell) {
                        calculatedCell.textContent = formatRupiah(0); // Set to 0 if not used
                    }
                }
            });
            document.getElementById('labor_total').textContent = formatRupiah(totalCost);
            return totalCost;
        }

        // Function to calculate reinforcing bar cost
        function calculateRebar() {
            let totalCost = 0;
            const rebarRows = document.querySelectorAll('#rebar_tbody tr:not(.total-row)');

            rebarRows.forEach(row => {
                const checkbox = row.querySelector('.use-checkbox');
                const lengthInput = row.querySelector('input[data-cost-type="rebar-length"]');
                const pricePerMeterInput = row.querySelector('input[data-cost-type="rebar-price-per-meter"]');
                const calculatedCell = row.querySelector('.calculated'); // The cell where total cost will be displayed

                if (!checkbox || checkbox.checked) {
                    const length = parseFloat(lengthInput ? lengthInput.value : 0) || 0;
                    const pricePerMeter = parseFloat(pricePerMeterInput ? pricePerMeterInput.value : 0) || 0;
                    
                    const rowTotal = length * pricePerMeter; // Calculate total cost (length * price, NOT scaled by total_volume)
                    
                    if (calculatedCell) {
                        calculatedCell.textContent = formatRupiah(rowTotal); // Update the calculated cell
                    }
                    totalCost += rowTotal;
                } else {
                    if (calculatedCell) {
                        calculatedCell.textContent = formatRupiah(0); // Set to 0 if not used
                    }
                }
            });
            document.getElementById('rebar_total').textContent = formatRupiah(totalCost);
            return totalCost;
        }

        // Function to toggle row and input states based on checkbox
        function toggleRow(checkbox) {
            const row = checkbox.closest('tr');
            // Select all editable inputs within this row, regardless of data-cost-type
            const inputs = row.querySelectorAll('input.editable'); 
            
            if (checkbox.checked) {
                row.classList.remove('disabled-row');
                inputs.forEach(input => {
                    input.removeAttribute('disabled');
                    // Restore original value only if it was set to 0 due to being disabled
                    if (input.type === 'number' && input.dataset.originalValue && parseFloat(input.value) === 0) {
                        input.value = input.dataset.originalValue;
                        delete input.dataset.originalValue; // Clean up the stored value
                    }
                });
            } else {
                row.classList.add('disabled-row');
                inputs.forEach(input => {
                    // Store original value before disabling and setting to 0
                    if (input.type === 'number' && input.value !== "0") {
                        input.dataset.originalValue = input.value;
                    }
                    input.setAttribute('disabled', 'true');
                    // Explicitly set value to 0 when disabled to ensure it doesn't affect total
                    if (input.type === 'number') {
                        input.value = 0;
                    }
                });
            }
            calculateAll(); // Recalculate after toggling
        }


        // Functions for adding new rows dynamically
        function addMaterialRow() {
            const tbody = document.getElementById('materials_tbody');
            const newRow = document.createElement('tr'); // Create tr element
            newRow.innerHTML = `
                <td><input type="text" class="editable" value="New Material" data-cost-type="material-name" onchange="calculateAll()"></td>
                <td><input type="text" class="editable" value="Custom Description" data-cost-type="material-desc" onchange="calculateAll()"></td>
                <td><input type="number" class="editable" data-cost-type="material-qty" value="1" step="0.1" onchange="calculateAll()"> Kg/m³</td>
                <td><input type="number" class="editable" data-cost-type="material-price" value="1000" onchange="calculateAll()"> Rp/Kg</td>
                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                <td class="calculated"></td>
            `;
            // Append the new row before the total-row if it exists
            const totalRow = tbody.querySelector('.total-row');
            if (totalRow) {
                tbody.insertBefore(newRow, totalRow);
            } else {
                tbody.appendChild(newRow); // Fallback if no total row
            }
            updateTotalColspan('materials_tbody'); 
            calculateAll();
        }

        function addRebarRow() {
            const tbody = document.getElementById('rebar_tbody');
            const newRow = document.createElement('tr'); // Create tr element
            newRow.innerHTML = `
                <td><input type="text" class="editable" value="New Rebar" data-cost-type="rebar-name" onchange="calculateAll()"></td>
                <td><input type="text" class="editable" value="Custom Description" data-cost-type="rebar-desc" onchange="calculateAll()"></td>
                <td><input type="number" class="editable" data-cost-type="rebar-length" value="10" step="0.1" onchange="calculateAll()"></td>
                <td>Meter</td>
                <td><input type="number" class="editable" data-cost-type="rebar-price-per-meter" value="7000" onchange="calculateAll()"></td>
                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                <td class="calculated"></td>
            `;
            // Append the new row before the total-row if it exists
            const totalRow = tbody.querySelector('.total-row');
            if (totalRow) {
                tbody.insertBefore(newRow, totalRow);
            } else {
                tbody.appendChild(newRow); // Fallback if no total row
            }
            updateTotalColspan('rebar_tbody'); 
            calculateAll();
        }

        function addEquipmentRow() {
            const tbody = document.getElementById('equipment_tbody');
            const newRow = document.createElement('tr'); // Create tr element
            newRow.innerHTML = `
                <td><input type="text" class="editable" value="New Equipment" data-cost-type="equipment-name" onchange="calculateAll()"></td>
                <td><input type="number" class="editable" data-cost-type="equipment-qty" value="1" onchange="calculateAll()"></td>
                <td>Unit</td>
                <td><input type="number" class="editable" data-cost-type="equipment-rate" value="100000" onchange="calculateAll()"></td>
                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                <td class="calculated"></td>
            `;
            // Append the new row before the total-row if it exists
            const totalRow = tbody.querySelector('.total-row');
            if (totalRow) {
                tbody.insertBefore(newRow, totalRow);
            } else {
                tbody.appendChild(newRow); // Fallback if no total row
            }
            updateTotalColspan('equipment_tbody'); 
            calculateAll();
        }

        function addLaborRow() {
            const tbody = document.getElementById('labor_tbody');
            const newRow = document.createElement('tr'); // Create tr element
            newRow.innerHTML = `
                <td><input type="text" class="editable" value="New Worker" data-cost-type="labor-name" onchange="calculateAll()"></td>
                <td>Custom Task</td>
                <td><input type="number" class="editable" data-cost-type="labor-qty" value="1" onchange="calculateAll()"></td>
                <td><input type="number" class="editable" data-cost-type="labor-time" value="480" onchange="calculateAll()"></td>
                <td><input type="number" class="editable" data-cost-type="labor-rate" value="20000" onchange="calculateAll()"></td>
                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                <td class="calculated"></td>
            `;
            // Append the new row before the total-row if it exists
            const totalRow = tbody.querySelector('.total-row');
            if (totalRow) {
                tbody.insertBefore(newRow, totalRow);
            } else {
                tbody.appendChild(newRow); // Fallback if no total row
            }
            updateTotalColspan('labor_tbody'); 
            calculateAll();
        }

        // Function to dynamically update colspan for total rows
        function updateTotalColspan(tbodyId) { // Removed defaultColspan as it's not needed anymore
            const tbody = document.getElementById(tbodyId);
            const totalRow = tbody.querySelector('.total-row');
            if (totalRow) {
                const totalTextCell = totalRow.querySelector('td:first-child');
                const exampleRow = tbody.querySelector('tr:not(.total-row):not(.subheader-row)');
                if (exampleRow) {
                    const numDataCellsInRow = exampleRow.querySelectorAll('td').length; // Get actual number of cells in a data row
                    totalTextCell.setAttribute('colspan', numDataCellsInRow - 1); // Span all but the last calculated cell
                } else {
                    // Fallback if no data rows exist (e.g., if all are deleted)
                    const numHeaders = tbody.closest('table').querySelectorAll('thead th').length;
                    totalTextCell.setAttribute('colspan', numHeaders - 1);
                }
            }
        }


        // Main function to calculate all costs and update the summary
        function calculateAll() {
            // --- Calculate Total Volume from L, W, H ---
            const length_mm = parseFloat(document.getElementById('length_mm').value) || 0;
            const width_mm = parseFloat(document.getElementById('width_mm').value) || 0;
            const height_mm = parseFloat(document.getElementById('height_mm').value) || 0;

            // Convert mm to meters for volume calculation (mm * mm * mm / 1,000,000,000)
            let total_volume_calculated_m3 = (length_mm / 1000) * (width_mm / 1000) * (height_mm / 1000);
            
            // Update the total_volume input field (read-only)
            document.getElementById('total_volume').value = total_volume_calculated_m3.toFixed(4); // Display with more precision for volume
            document.getElementById('display_volume').textContent = total_volume_calculated_m3.toFixed(2); // Display with 2 decimals in paragraph

            // Use this calculated volume for subsequent calculations
            let total_volume = total_volume_calculated_m3;


            // --- Otomatisasi Project Duration ---
            const volume_per_batch_for_hours = 0.2; // m³ per batch for 1 hour
            const time_per_batch_hours = 1; // 1 hour per batch (from 60 minutes reference)
            const daily_operating_hours = parseFloat(document.getElementById('daily_operating_hours').value) || 0;

            let calculated_project_duration_days = 0;
            let total_hours_needed_for_project = 0; // Renamed to clarify it's total work hours

            if (total_volume > 0 && volume_per_batch_for_hours > 0) { // Ensure volume_per_batch is not zero
                total_hours_needed_for_project = (total_volume / volume_per_batch_for_hours) * time_per_batch_hours;
                if (daily_operating_hours > 0) { // Only divide if daily_operating_hours is valid
                    calculated_project_duration_days = total_hours_needed_for_project / daily_operating_hours;
                } else {
                    calculated_project_duration_days = total_hours_needed_for_project / 8; // Default to 8 hours/day if not specified
                }
            }
            
            // Update the project_duration input field (in days)
            document.getElementById('project_duration').value = calculated_project_duration_days.toFixed(2);

            // Calculate and display in hours and minutes
            const total_minutes_needed_for_project = total_hours_needed_for_project * 60;
            const display_hours = Math.floor(total_minutes_needed_for_project / 60);
            const display_minutes = Math.round(total_minutes_needed_for_project % 60); // Round minutes for better display
            document.getElementById('project_duration_hours_minutes').textContent = `(${display_hours} hours, ${display_minutes} minutes)`;
            // --- End Otomatisasi Project Duration ---


            // Update detailed geometry outputs and independent ink extrusion cost display
            updateInkExtrusionCostDisplay();


            // Call individual cost calculation functions for project total
            // Pass total_hours_needed_for_project to functions that need it
            const printer_cost = calculatePrinterCost(); // printer_cost calculation already uses total_project_hours_needed internally for 'hour' unit
            const equipment_total = calculateEquipment();
            const materials_total = calculateMaterials(); // This now also updates the new Material Quantity Summary
            const labor_total = calculateLabor(); // labor_total calculation now uses total_project_hours_needed internally
            const rebar_total = calculateRebar(); 

            // Grand total project does NOT include the independent Ink Extrusion Cost
            const grand_total_project = printer_cost + equipment_total + materials_total + labor_total + rebar_total;
            
            // Calculate cost per cubic meter based on the *input* total_volume
            let cost_per_cubic = 0;
            if (total_volume > 0) {
                cost_per_cubic = grand_total_project / total_volume;
            }

            document.getElementById('cost_per_cubic').textContent = formatRupiah(cost_per_cubic);

            // Update summary table
            // Ensure division by total_volume is safe (if volume > 0)
            document.getElementById('printer_per_cubic').textContent = formatRupiah(printer_cost / (total_volume > 0 ? total_volume : 1));
            document.getElementById('printer_project_total').textContent = formatRupiah(printer_cost);

            document.getElementById('equipment_per_cubic').textContent = formatRupiah(equipment_total / (total_volume > 0 ? total_volume : 1));
            document.getElementById('equipment_project_total').textContent = formatRupiah(equipment_total);

            // For materials, the 'materials_total' from the function is already the project total.
            // materials_per_cubic needs to be calculated by dividing the project total materials cost by the input total_volume.
            document.getElementById('materials_per_cubic').textContent = formatRupiah(materials_total / (total_volume > 0 ? total_volume : 1)); 
            document.getElementById('materials_project_total').textContent = formatRupiah(materials_total);

            document.getElementById('labor_per_cubic').textContent = formatRupiah(labor_total / (total_volume > 0 ? total_volume : 1));
            document.getElementById('labor_project_total').textContent = formatRupiah(labor_total); 

            // For rebar, the 'rebar_total' from the function is already the project total.
            // rebar_per_cubic needs to be calculated by dividing the project total rebar cost by the input total_volume.
            document.getElementById('rebar_per_cubic').textContent = formatRupiah(rebar_total / (total_volume > 0 ? total_volume : 1));
            document.getElementById('rebar_project_total').textContent = formatRupiah(rebar_total);

            document.getElementById('grand_total_per_cubic').textContent = formatRupiah(cost_per_cubic);
            document.getElementById('grand_total_project').textContent = formatRupiah(grand_total_project);

            // Calculate percentages
            updatePercentages(grand_total_project, printer_cost, equipment_total, materials_total, labor_total, rebar_total);
        }

        // Function to update percentages in the summary table
        function updatePercentages(grandTotal, printerCost, equipmentCost, materialsCost, laborCost, rebarCost) {
            if (grandTotal === 0) {
                document.getElementById('printer_percentage').textContent = '0%';
                document.getElementById('equipment_percentage').textContent = '0%';
                document.getElementById('materials_percentage').textContent = '0%';
                document.getElementById('labor_percentage').textContent = '0%';
                document.getElementById('rebar_percentage').textContent = '0%';
                document.getElementById('grand_total_percentage').textContent = '0%'; 
                return;
            }

            document.getElementById('printer_percentage').textContent = ((printerCost / grandTotal) * 100).toFixed(1) + '%';
            document.getElementById('equipment_percentage').textContent = ((equipmentCost / grandTotal) * 100).toFixed(1) + '%';
            document.getElementById('materials_percentage').textContent = ((materialsCost / grandTotal) * 100).toFixed(1) + '%';
            document.getElementById('labor_percentage').textContent = ((laborCost / grandTotal) * 100).toFixed(1) + '%';
            document.getElementById('rebar_percentage').textContent = ((rebarCost / grandTotal) * 100).toFixed(1) + '%';
            document.getElementById('grand_total_percentage').textContent = '100%'; 
        }

        // Initialize calculations on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderPrinterCards();
            // Select the first printer's first option by default for immediate functionality
            selectPrinter(PRINTERS[0].name, 0, 0); 
            // The initial state of checkboxes will be 'checked' by default.
            // When calculateAll() runs on load, it. will use these checked states.
            updateProjectNameForPrint(); // Initial update for project name
            updateTotalColspan('materials_tbody');
            updateTotalColspan('rebar_tbody');
            updateTotalColspan('equipment_tbody');
            updateTotalColspan('labor_tbody');
        });
    </script>
</body>
</html>
